name: gor-signoz

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workdir:
          - pkg/query-service
          - ee/query-service
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: get-sha
        shell: bash
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
      - name: dotenv-frontend
        if: matrix.workdir == 'ee/query-service'
        working-directory: frontend
        run: |
          echo 'INTERCOM_APP_ID="${{ secrets.INTERCOM_APP_ID }}"' > .env
          echo 'SEGMENT_ID="${{ secrets.SEGMENT_ID }}"' >> .env
          echo 'SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}"' >> .env
          echo 'SENTRY_ORG="${{ secrets.SENTRY_ORG }}"' >> .env
          echo 'SENTRY_PROJECT_ID="${{ secrets.SENTRY_PROJECT_ID }}"' >> .env
          echo 'SENTRY_DSN="${{ secrets.SENTRY_DSN }}"' >> .env
          echo 'TUNNEL_URL="${{ secrets.TUNNEL_URL }}"' >> .env
          echo 'TUNNEL_DOMAIN="${{ secrets.TUNNEL_DOMAIN }}"' >> .env
          echo 'POSTHOG_KEY="${{ secrets.POSTHOG_KEY }}"' >> .env
          echo 'CUSTOMERIO_ID="${{ secrets.CUSTOMERIO_ID }}"' >> .env
          echo 'CUSTOMERIO_SITE_ID="${{ secrets.CUSTOMERIO_SITE_ID }}"' >> .env
      - name: build-frontend
        run: make build-frontend-static
      - name: upload-frontend-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.workdir }}-frontend-build
          path: frontend/build
  build:
    needs: prepare
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
        workdir:
          - pkg/query-service
          - ee/query-service
    runs-on: ${{ matrix.os }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: setup-qemu
        uses: docker/setup-qemu-action@v3
        if: matrix.os == 'ubuntu-latest'
      - name: setup-buildx
        uses: docker/setup-buildx-action@v3
        if: matrix.os == 'ubuntu-latest'
      - name: ghcr-login
        uses: docker/login-action@v3
        if: matrix.os != 'macos-latest'
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: setup-go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: cross-compilation-tools
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools
      - name: download-frontend-artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.workdir }}-frontend-build
          path: frontend/build
      - name: get-sha
        shell: bash
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
      - name: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ matrix.workdir }}/frontend-build
          key: frontend-${{ env.sha_short }}
      - name: cache-linux
        uses: actions/cache@v4
        if: matrix.os == 'ubuntu-latest'
        with:
          path: ${{ matrix.workdir }}/dist/linux
          key: linux-${{ env.sha_short }}
      - name: cache-darwin
        uses: actions/cache@v4
        if: matrix.os == 'macos-latest'
        with:
          path: ${{ matrix.workdir }}/dist/darwin
          key: darwin-${{ env.sha_short }}
      - name: release
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser-pro
          version: '~> v2'
          args: release --clean --split
          workdir: ${{ matrix.workdir }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
  release:
    runs-on: ubuntu-latest
    needs: build
    env:
      DOCKER_CLI_EXPERIMENTAL: "enabled"
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: setup-qemu
        uses: docker/setup-qemu-action@v3
      - name: setup-buildx
        uses: docker/setup-buildx-action@v3
      - name: cosign-installer
        uses: sigstore/cosign-installer@v3.8.1
      - name: download-syft
        uses: anchore/sbom-action/download-syft@v0.18.0
      - name: ghcr-login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: setup-go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # copy the caches from build
      - name: get-sha
        shell: bash
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
      - name: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ matrix.workdir }}/frontend-build
          key: frontend-${{ env.sha_short }}
      - name: cache-linux
        uses: actions/cache@v4
        with:
          path: ${{ matrix.workdir }}/dist/linux
          key: linux-${{ env.sha_short }}
      - name: cache-darwin
        uses: actions/cache@v4
        with:
          path: ${{ matrix.workdir }}/dist/darwin
          key: darwin-${{ env.sha_short }}

      # release
      - uses: goreleaser/goreleaser-action@v6
        if: steps.cache.outputs.cache-hit != 'true' # do not run if cache hit
        with:
          distribution: goreleaser-pro
          version: '~> v2'
          args: continue --merge
          workdir: ${{ matrix.workdir }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}

